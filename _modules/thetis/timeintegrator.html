<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>thetis.timeintegrator &#8212; Thetis 1.0 documentation</title>
    
    <link rel="stylesheet" href="../../_static/fenics.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Thetis 1.0 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

<link rel="stylesheet" href="../../_static/featured.css">


<link rel="shortcut icon" href="../../_static/icon.ico" />


  </head>
  <body role="document">
<div class="wrapper">
  <a href="../../index.html"><img src="../../_static/banner.png" height="200px" alt="Thetis Project Banner" /></a>
  <div id="access">
    <div class="menu">
      <ul>
        <li class="page_item"><a href="../../documentation.html" title="Documentation for Firedrake">Documentation</a></li>
        <li class="page_item"><a href="../../download.html" title="Obtain the firedrake code">Download</a></li>
        <li class="page_item"><a href="../../team.html" title="The guilty parties">Team</a></li>
        <li class="page_item"><a href="../../publications.html" title="Publications">Publications</a></li>
        <li class="page_item"><a href="../../funding.html" title="Our financial supporters">Funding</a></li>
        <li class="page_item"><a href="../../contact.html" title="Getting in touch">Contact</a></li>
        <li class="page_item"><a href="https://github.com/thetisproject/thetis" title="GitHub">GitHub</a></li>
        <li class="page_item"><a href="https://travis-ci.org/thetisproject/thetis" title="Travis">Travis</a></li>
      </ul>
    </div><!-- .menu -->
  </div><!-- #access -->
</div><!-- #wrapper -->


    <div class="document">
    <div class="_modules/thetis/timeintegrator">
      
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thetis.timeintegrator</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Generic time integration schemes to advance equations in time.</span>

<span class="sd">Tuomas Karna 2015-03-27</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">.utility</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="k">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractproperty</span>


<div class="viewcode-block" id="TimeIntegrator"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.TimeIntegrator">[docs]</a><span class="k">class</span> <span class="nc">TimeIntegrator</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for all time integrator objects.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equation</span> <span class="o">=</span> <span class="n">equation</span>
        <span class="c1"># unique identifier for solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">solver_parameters</span><span class="p">)</span>

<div class="viewcode-block" id="TimeIntegrator.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.TimeIntegrator.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">((</span><span class="s1">&#39;This method must be implemented &#39;</span>
                                   <span class="s1">&#39;in the derived class&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="TimeIntegrator.advance"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.TimeIntegrator.advance">[docs]</a>    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">((</span><span class="s1">&#39;This method must be implemented &#39;</span>
                                   <span class="s1">&#39;in the derived class&#39;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="SSPRK33"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33">[docs]</a><span class="k">class</span> <span class="nc">SSPRK33</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    3rd order Strong Stability Preserving Runge-Kutta scheme, SSP(3,3).</span>

<span class="sd">    This scheme has Butcher tableau</span>
<span class="sd">    0   |</span>
<span class="sd">    1   | 1</span>
<span class="sd">    1/2 | 1/4 1/4</span>
<span class="sd">    ---------------</span>
<span class="sd">        | 1/6 1/6 2/3</span>

<span class="sd">    CFL coefficient is 1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="p">{},</span>
                 <span class="n">funcs_nplushalf</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Creates forms for the time integrator&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SSPRK33</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explicit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CFL_coeff</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_n</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>  <span class="c1"># for single stages</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">K0</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K1</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K2</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>

        <span class="c1"># dict of all input functions needed for the equation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="c1"># create functions to hold the values of previous time step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">FiredrakeFunction</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">function_space</span><span class="p">())</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">FiredrakeConstant</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">funcs_nplushalf</span> <span class="o">=</span> <span class="n">funcs_nplushalf</span>
        <span class="c1"># values used in equations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">FiredrakeFunction</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">function_space</span><span class="p">())</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">FiredrakeConstant</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_rk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">trial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_RK0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_RK1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_RK2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="SSPRK33.update_solver"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33.update_solver">[docs]</a>    <span class="k">def</span> <span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds linear problems for each stage. These problems need to be</span>
<span class="sd">        re-created after each mesh update.&quot;&quot;&quot;</span>
        <span class="n">prob_k0</span> <span class="o">=</span> <span class="n">LinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_RK0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_k0</span> <span class="o">=</span> <span class="n">LinearVariationalSolver</span><span class="p">(</span><span class="n">prob_k0</span><span class="p">,</span> <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_k0&#39;</span><span class="p">,</span>
                                                 <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">)</span>
        <span class="n">prob_k1</span> <span class="o">=</span> <span class="n">LinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_RK1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_k1</span> <span class="o">=</span> <span class="n">LinearVariationalSolver</span><span class="p">(</span><span class="n">prob_k1</span><span class="p">,</span> <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_k1&#39;</span><span class="p">,</span>
                                                 <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">)</span>
        <span class="n">prob_k2</span> <span class="o">=</span> <span class="n">LinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_RK2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_k2</span> <span class="o">=</span> <span class="n">LinearVariationalSolver</span><span class="p">(</span><span class="n">prob_k2</span><span class="p">,</span> <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_k2&#39;</span><span class="p">,</span>
                                                 <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPRK33.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="c1"># assign values to old functions</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div>

<div class="viewcode-block" id="SSPRK33.advance"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33.advance">[docs]</a>    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="c1"># stage 0</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_k0</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="c1"># stage 1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">K0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_k1</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="c1"># stage 2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span> <span class="o">+</span> <span class="mf">0.25</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K0</span> <span class="o">+</span> <span class="mf">0.25</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>  <span class="c1"># set args to t+dt/2</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcs_nplushalf</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcs_nplushalf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_k2</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="c1"># final solution</span>
        <span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K0</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K1</span> <span class="o">+</span>
                        <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K2</span><span class="p">)</span>

        <span class="c1"># store old values</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPRK33.solve_stage"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33.solve_stage">[docs]</a>    <span class="k">def</span> <span class="nf">solve_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># stage 0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_n</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_k0</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">K0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># stage 1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_k1</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_n</span> <span class="o">+</span> <span class="mf">0.25</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K0</span> <span class="o">+</span> <span class="mf">0.25</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># stage 2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>  <span class="c1"># set args to t+dt/2</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">funcs_nplushalf</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">funcs_nplushalf</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_new</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_k2</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="c1"># final solution</span>
            <span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_n</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K0</span> <span class="o">+</span>
                            <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K2</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SSPRK33Stage"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33Stage">[docs]</a><span class="k">class</span> <span class="nc">SSPRK33Stage</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    3rd order Strong Stability Preserving Runge-Kutta scheme, SSP(3,3).</span>
<span class="sd">    This class only advances one step at a time.</span>

<span class="sd">    This scheme has Butcher tableau</span>
<span class="sd">    0   |</span>
<span class="sd">    1   | 1</span>
<span class="sd">    1/2 | 1/4 1/4</span>
<span class="sd">    ---------------</span>
<span class="sd">        | 1/6 1/6 2/3</span>

<span class="sd">    CFL coefficient is 1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Creates forms for the time integrator&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SSPRK33Stage</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">explicit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CFL_coeff</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">=</span> <span class="mi">3</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;old solution&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_n</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;stage solution&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">K0</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tendency0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K1</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tendency1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K2</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tendency2&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># fully explicit evaluation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_rk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">trial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L_RK</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="SSPRK33Stage.update_solver"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33Stage.update_solver">[docs]</a>    <span class="k">def</span> <span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds linear problems for each stage. These problems need to be</span>
<span class="sd">        re-created after each mesh update.&quot;&quot;&quot;</span>
        <span class="n">prob_k0</span> <span class="o">=</span> <span class="n">LinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_RK</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_k0</span> <span class="o">=</span> <span class="n">LinearVariationalSolver</span><span class="p">(</span><span class="n">prob_k0</span><span class="p">,</span> <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_k0&#39;</span><span class="p">,</span>
                                                 <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">)</span>
        <span class="n">prob_k1</span> <span class="o">=</span> <span class="n">LinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_RK</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_k1</span> <span class="o">=</span> <span class="n">LinearVariationalSolver</span><span class="p">(</span><span class="n">prob_k1</span><span class="p">,</span> <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_k1&#39;</span><span class="p">,</span>
                                                 <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">)</span>
        <span class="n">prob_k2</span> <span class="o">=</span> <span class="n">LinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L_RK</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">K2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_k2</span> <span class="o">=</span> <span class="n">LinearVariationalSolver</span><span class="p">(</span><span class="n">prob_k2</span><span class="p">,</span> <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_k2&#39;</span><span class="p">,</span>
                                                 <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPRK33Stage.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33Stage.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPRK33Stage.solve_stage"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33Stage.solve_stage">[docs]</a>    <span class="k">def</span> <span class="nf">solve_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves a single stage of step from t to t+dt.</span>
<span class="sd">        All functions that the equation depends on must be at right state</span>
<span class="sd">        corresponding to each sub-step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># stage 0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_n</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_k0</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_n</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">K0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># stage 1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_k1</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_n</span> <span class="o">+</span> <span class="mf">0.25</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K0</span> <span class="o">+</span> <span class="mf">0.25</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># stage 2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_k2</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="c1"># final solution</span>
            <span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_n</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K0</span> <span class="o">+</span>
                            <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K1</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">K2</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPRK33Stage.advance"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33Stage.advance">[docs]</a>    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances one full time step from t to t+dt.</span>
<span class="sd">        This assumes that all the functions that the equation depends on are</span>
<span class="sd">        constants across this interval. If dependent functions need to be</span>
<span class="sd">        updated call solve_stage instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_stage</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span>
                             <span class="n">update_forcings</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="SSPRK33StageSemiImplicit"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33StageSemiImplicit">[docs]</a><span class="k">class</span> <span class="nc">SSPRK33StageSemiImplicit</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    3rd order Strong Stability Preserving Runge-Kutta scheme, SSP(3,3).</span>
<span class="sd">    This class only advances one step at a time.</span>

<span class="sd">    This scheme has Butcher tableau</span>
<span class="sd">    0   |</span>
<span class="sd">    1   | 1</span>
<span class="sd">    1/2 | 1/4 1/4</span>
<span class="sd">    ---------------</span>
<span class="sd">        | 1/6 1/6 2/3</span>

<span class="sd">    CFL coefficient is 1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">solver_parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">semi_implicit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates forms for the time integrator&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SSPRK33StageSemiImplicit</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_monitor&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">semi_implicit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;ksponly&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;newtonls&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">explicit</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">CFL_coeff</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;old solution&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sol0</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sol1</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">semi_implicit</span><span class="p">:</span>
            <span class="c1"># linearize around previous sub-timestep using the fact that all terms are written in the form A(u_nl) u</span>
            <span class="n">sol_nl0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span>
            <span class="n">sol_nl1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol0</span>
            <span class="n">sol_nl2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># solve the full nonlinear residual form</span>
            <span class="n">sol_nl0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol0</span>
            <span class="n">sol_nl1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol1</span>
            <span class="n">sol_nl2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span>

        <span class="c1"># FIXME old solution should be set correctly, this is consistent with old formulation</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_0</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sol0</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">)</span> <span class="o">-</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol0</span><span class="p">,</span> <span class="n">sol_nl0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span>
                        <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sol1</span><span class="p">)</span> <span class="o">-</span>
                    <span class="mf">3.0</span><span class="o">/</span><span class="mf">4.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">4.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sol0</span><span class="p">)</span> <span class="o">-</span>
                    <span class="mf">1.0</span><span class="o">/</span><span class="mf">4.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol1</span><span class="p">,</span> <span class="n">sol_nl1</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span>
                        <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span> <span class="o">-</span>
                    <span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">)</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sol1</span><span class="p">)</span> <span class="o">-</span>
                    <span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span> <span class="n">sol_nl2</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span>
                        <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol1</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol1</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="o">+</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">))</span>
                    <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="SSPRK33StageSemiImplicit.update_solver"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33StageSemiImplicit.update_solver">[docs]</a>    <span class="k">def</span> <span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Builds linear problems for each stage. These problems need to be</span>
<span class="sd">        re-created after each mesh update.&quot;&quot;&quot;</span>
        <span class="n">prob_f0</span> <span class="o">=</span> <span class="n">NonlinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_f0</span> <span class="o">=</span> <span class="n">NonlinearVariationalSolver</span><span class="p">(</span><span class="n">prob_f0</span><span class="p">,</span> <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_k0&#39;</span><span class="p">,</span>
                                                    <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">)</span>
        <span class="n">prob_f1</span> <span class="o">=</span> <span class="n">NonlinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_f1</span> <span class="o">=</span> <span class="n">NonlinearVariationalSolver</span><span class="p">(</span><span class="n">prob_f1</span><span class="p">,</span> <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_k1&#39;</span><span class="p">,</span>
                                                    <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">)</span>
        <span class="n">prob_f2</span> <span class="o">=</span> <span class="n">NonlinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_f2</span> <span class="o">=</span> <span class="n">NonlinearVariationalSolver</span><span class="p">(</span><span class="n">prob_f2</span><span class="p">,</span> <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_k2&#39;</span><span class="p">,</span>
                                                    <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPRK33StageSemiImplicit.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33StageSemiImplicit.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPRK33StageSemiImplicit.solve_stage"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33StageSemiImplicit.solve_stage">[docs]</a>    <span class="k">def</span> <span class="nf">solve_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves a single stage of step from t to t+dt.</span>
<span class="sd">        All functions that the equation depends on must be at rigth state</span>
<span class="sd">        corresponding to each sub-step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># stage 0</span>
            <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_f0</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sol0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># stage 1</span>
            <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_f1</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sol1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># stage 2</span>
            <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_f2</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPRK33StageSemiImplicit.advance"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPRK33StageSemiImplicit.advance">[docs]</a>    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances one full time step from t to t+dt.</span>
<span class="sd">        This assumes that all the functions that the equation depends on are</span>
<span class="sd">        constants across this interval. If dependent functions need to be</span>
<span class="sd">        updated call solve_stage instead.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_stage</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span>
                             <span class="n">update_forcings</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ForwardEuler"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.ForwardEuler">[docs]</a><span class="k">class</span> <span class="nc">ForwardEuler</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Standard forward Euler time integration scheme.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Creates forms for the time integrator&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ForwardEuler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">)</span>

        <span class="c1"># dict of all input functions needed for the equation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="c1"># create functions to hold the values of previous time step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">FiredrakeFunction</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">function_space</span><span class="p">())</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">FiredrakeConstant</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">u_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span>
        <span class="n">u_tri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">trial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="n">u_tri</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="n">u_old</span><span class="p">)</span> <span class="o">+</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">u_old</span><span class="p">,</span> <span class="n">u_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
                  <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="ForwardEuler.update_solver"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.ForwardEuler.update_solver">[docs]</a>    <span class="k">def</span> <span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">LinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">LinearVariationalSolver</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                              <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">)</span></div>

<div class="viewcode-block" id="ForwardEuler.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.ForwardEuler.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="c1"># assign values to old functions</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div>

<div class="viewcode-block" id="ForwardEuler.advance"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.ForwardEuler.advance">[docs]</a>    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="c1"># shift time</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="CrankNicolson"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.CrankNicolson">[docs]</a><span class="k">class</span> <span class="nc">CrankNicolson</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Standard Crank-Nicolson time integration scheme.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">semi_implicit</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates forms for the time integrator&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CrankNicolson</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_monitor&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">semi_implicit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;ksponly&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;newtonls&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;solution_old&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="c1"># create functions to hold the values of previous time step</span>
        <span class="c1"># TODO is this necessary? is self.fields sufficient?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">FiredrakeFunction</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;_old&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">FiredrakeConstant</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span>
        <span class="n">u_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span>
        <span class="k">if</span> <span class="n">semi_implicit</span><span class="p">:</span>
            <span class="c1"># linearize around last timestep using the fact that all terms are written in the form A(u_nl) u</span>
            <span class="c1"># (currently only true for the SWE)</span>
            <span class="n">u_nl</span> <span class="o">=</span> <span class="n">u_old</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># solve the full nonlinear residual form</span>
            <span class="n">u_nl</span> <span class="o">=</span> <span class="n">u</span>
        <span class="n">bnd</span> <span class="o">=</span> <span class="n">bnd_conditions</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>
        <span class="n">f_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span>

        <span class="c1"># Crank-Nicolson</span>
        <span class="n">theta_const</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="c1"># FIXME this is consistent with previous implementation but time levels are incorrect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="n">u_old</span><span class="p">)</span> <span class="o">-</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="p">(</span><span class="n">theta_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">u_nl</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">bnd</span><span class="p">)</span> <span class="o">+</span>
                                 <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta_const</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">u_old</span><span class="p">,</span> <span class="n">u_old</span><span class="p">,</span> <span class="n">f_old</span><span class="p">,</span> <span class="n">f_old</span><span class="p">,</span> <span class="n">bnd</span><span class="p">)</span>
                                 <span class="p">)</span>
                  <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="CrankNicolson.update_solver"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.CrankNicolson.update_solver">[docs]</a>    <span class="k">def</span> <span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Ensure LU assembles monolithic matrices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pc_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;lu&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">[</span><span class="s1">&#39;mat_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;aij&#39;</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">NonlinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">NonlinearVariationalSolver</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span>
                                                 <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">,</span>
                                                 <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="CrankNicolson.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.CrankNicolson.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="c1"># assign values to old functions</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div>

<div class="viewcode-block" id="CrankNicolson.advance"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.CrankNicolson.advance">[docs]</a>    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="c1"># shift time</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="SteadyState"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SteadyState">[docs]</a><span class="k">class</span> <span class="nc">SteadyState</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Time integrator that solves the steady state equations, leaving out the mass terms&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Creates forms for the time integrator&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SteadyState</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_monitor&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;newtonls&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="SteadyState.update_solver"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SteadyState.update_solver">[docs]</a>    <span class="k">def</span> <span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Ensure LU assembles monolithic matrices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pc_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;lu&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">[</span><span class="s1">&#39;mat_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;aij&#39;</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">NonlinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">NonlinearVariationalSolver</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span>
                                                 <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">,</span>
                                                 <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></div>

<div class="viewcode-block" id="SteadyState.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SteadyState.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="c1"># nothing to do here as the initial condition is passed in via solution</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="SteadyState.advance"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SteadyState.advance">[docs]</a>    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span><span class="o">+</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="SSPIMEX"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPIMEX">[docs]</a><span class="k">class</span> <span class="nc">SSPIMEX</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SSP-IMEX time integration scheme based on [1], method (17).</span>

<span class="sd">    [1] Higueras et al (2014). Optimized strong stability preserving IMEX</span>
<span class="sd">        Runge-Kutta methods. Journal of Computational and Applied</span>
<span class="sd">        Mathematics 272(2014) 116-140.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">solver_parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">solver_parameters_dirk</span><span class="o">=</span><span class="p">{}):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SSPIMEX</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="p">)</span>

        <span class="c1"># implicit scheme</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirk</span> <span class="o">=</span> <span class="n">DIRKLSPUM2</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">,</span>
                               <span class="n">solver_parameters</span><span class="o">=</span><span class="n">solver_parameters_dirk</span><span class="p">,</span>
                               <span class="n">terms_to_add</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">))</span>
        <span class="c1"># explicit scheme</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">erk</span> <span class="o">=</span> <span class="n">ERKLSPUM2</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">,</span>
                             <span class="n">solver_parameters</span><span class="o">=</span><span class="n">solver_parameters</span><span class="p">,</span>
                             <span class="n">terms_to_add</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;explicit&#39;</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">erk</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

<div class="viewcode-block" id="SSPIMEX.update_solver"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPIMEX.update_solver">[docs]</a>    <span class="k">def</span> <span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirk</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">erk</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span></div>

<div class="viewcode-block" id="SSPIMEX.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPIMEX.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirk</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">erk</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPIMEX.advance"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPIMEX.advance">[docs]</a>    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_stage</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_final_solution</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPIMEX.solve_stage"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPIMEX.solve_stage">[docs]</a>    <span class="k">def</span> <span class="nf">solve_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">erk</span><span class="o">.</span><span class="n">solve_stage</span><span class="p">(</span><span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirk</span><span class="o">.</span><span class="n">solve_stage</span><span class="p">(</span><span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPIMEX.get_final_solution"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.SSPIMEX.get_final_solution">[docs]</a>    <span class="k">def</span> <span class="nf">get_final_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">erk</span><span class="o">.</span><span class="n">get_final_solution</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirk</span><span class="o">.</span><span class="n">get_final_solution</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DIRKGeneric"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.DIRKGeneric">[docs]</a><span class="k">class</span> <span class="nc">DIRKGeneric</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic implementation of Diagonally Implicit Runge Kutta schemes.</span>

<span class="sd">    Method is defined by its Butcher tableau</span>

<span class="sd">    c[0] | a[0, 0]</span>
<span class="sd">    c[1] | a[1, 0] a[1, 1]</span>
<span class="sd">    c[2] | a[2, 0] a[2, 1] a[2, 2]</span>
<span class="sd">    ------------------------------</span>
<span class="sd">         | b[0]    b[1]    b[2]</span>

<span class="sd">    All derived classes must define the tableau via properties</span>
<span class="sd">    a  : array_like (n_stages, n_stages)</span>
<span class="sd">        coefficients for the Butcher tableau, must be lower diagonal</span>
<span class="sd">    b,c : array_like (n_stages,)</span>
<span class="sd">        coefficients for the Butcher tableau</span>

<span class="sd">    This method also works for explicit RK schemes if one with the zeros on the first row of a.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span> <span class="nf">a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span> <span class="nf">b</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span> <span class="nf">c</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span>
                 <span class="n">bnd_conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="p">{},</span> <span class="n">terms_to_add</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create new DIRK solver.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        equation : equation object</span>
<span class="sd">            the equation to solve</span>
<span class="sd">        dt : float</span>
<span class="sd">            time step (constant)</span>
<span class="sd">        solver_parameters : dict</span>
<span class="sd">            PETSc options for solver</span>
<span class="sd">        terms_to_add : &#39;all&#39; or list of &#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;</span>
<span class="sd">            Defines which terms of the equation are to be added to this solver.</span>
<span class="sd">            Default &#39;all&#39; implies terms_to_add = [&#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_monitor&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;newtonls&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">=</span> <span class="n">solution</span>

        <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">test</span>
        <span class="n">mixed_space</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="c1"># Allocate tendency fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_k</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">fname</span><span class="p">))</span>
        <span class="c1"># construct variational problems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mixed_space</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="n">terms_to_add</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># solution must be split before computing sum</span>
            <span class="c1"># pass components to equation in a list</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of components in the mixed space</span>
                        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">),</span> <span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
                            <span class="n">u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
                            <span class="n">u</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="n">k</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="n">terms_to_add</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="DIRKGeneric.update_solver"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.DIRKGeneric.update_solver">[docs]</a>    <span class="k">def</span> <span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># construct solvers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">NonlinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">sname</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:}</span><span class="s1">_stage</span><span class="si">{:}</span><span class="s1">_&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">NonlinearVariationalSolver</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
                                           <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">,</span>
                                           <span class="n">options_prefix</span><span class="o">=</span><span class="n">sname</span> <span class="o">+</span> <span class="s1">&#39;_k</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span></div>

<div class="viewcode-block" id="DIRKGeneric.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.DIRKGeneric.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_cond</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">init_cond</span><span class="p">)</span></div>

<div class="viewcode-block" id="DIRKGeneric.advance"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.DIRKGeneric.advance">[docs]</a>    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_stage</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">update_forcings</span><span class="p">)</span></div>

<div class="viewcode-block" id="DIRKGeneric.solve_stage"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.DIRKGeneric.solve_stage">[docs]</a>    <span class="k">def</span> <span class="nf">solve_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one stage.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i_stage</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">[</span><span class="n">i_stage</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i_stage</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_stage_solution</span><span class="p">(</span><span class="n">i_stage</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># assign the final solution</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_final_solution</span><span class="p">(</span><span class="n">output</span><span class="p">)</span></div>

<div class="viewcode-block" id="DIRKGeneric.get_stage_solution"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.DIRKGeneric.get_stage_solution">[docs]</a>    <span class="k">def</span> <span class="nf">get_stage_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stores intermediate solution for stage i_stage to the output field&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">output</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">:</span>
            <span class="c1"># possible only if output is not the internal state container</span>
            <span class="n">output</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">i_stage</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">output</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i_stage</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">]</span></div>

<div class="viewcode-block" id="DIRKGeneric.get_final_solution"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.DIRKGeneric.get_final_solution">[docs]</a>    <span class="k">def</span> <span class="nf">get_final_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the final solution from the tendencies&quot;&quot;&quot;</span>
        <span class="c1"># update solution</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">output</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">:</span>
            <span class="c1"># copy to output</span>
            <span class="n">output</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BackwardEuler"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.BackwardEuler">[docs]</a><span class="k">class</span> <span class="nc">BackwardEuler</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Backward Euler method</span>

<span class="sd">    This method has the Butcher tableau</span>

<span class="sd">    1   | 1</span>
<span class="sd">    ---------</span>
<span class="sd">        | 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">1.0</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span></div>


<div class="viewcode-block" id="ImplicitMidpoint"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.ImplicitMidpoint">[docs]</a><span class="k">class</span> <span class="nc">ImplicitMidpoint</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implicit midpoint method, second order.</span>

<span class="sd">    This method has the Butcher tableau</span>

<span class="sd">    0.5 | 0.5</span>
<span class="sd">    ---------</span>
<span class="sd">        | 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.5</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span></div>


<div class="viewcode-block" id="DIRK22"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.DIRK22">[docs]</a><span class="k">class</span> <span class="nc">DIRK22</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DIRK22, 2-stage, 2nd order, L-stable</span>
<span class="sd">    Diagonally Implicit Runge Kutta method</span>

<span class="sd">    This method has the Butcher tableau</span>

<span class="sd">    gamma   | gamma     0</span>
<span class="sd">    1       | 1-gamma  gamma</span>
<span class="sd">    -------------------------</span>
<span class="sd">            | 0.5       0.5</span>
<span class="sd">    with</span>
<span class="sd">    gamma = (2 + sqrt(2))/2</span>

<span class="sd">    From DIRK(2,3,2) IMEX scheme in Ascher et al. (1997)</span>

<span class="sd">    [1] Ascher et al. (1997). Implicit-explicit Runge-Kutta methods for</span>
<span class="sd">        time-dependent partial differential equations. Applied Numerical</span>
<span class="sd">        Mathematics, 25:151-167.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">((</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="n">gamma</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">gamma</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">gamma</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="DIRK23"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.DIRK23">[docs]</a><span class="k">class</span> <span class="nc">DIRK23</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DIRK23, 2-stage, 3rd order</span>
<span class="sd">    Diagonally Implicit Runge Kutta method</span>

<span class="sd">    This method has the Butcher tableau</span>

<span class="sd">    gamma   | gamma     0</span>
<span class="sd">    1-gamma | 1-2*gamma gamma</span>
<span class="sd">    -------------------------</span>
<span class="sd">            | 0.5       0.5</span>
<span class="sd">    with</span>
<span class="sd">    gamma = (3 + sqrt(3))/6</span>

<span class="sd">    From DIRK(2,3,3) IMEX scheme in Ascher et al. (1997)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mi">6</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="n">gamma</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">gamma</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">gamma</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">gamma</span><span class="p">]</span></div>


<div class="viewcode-block" id="DIRK33"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.DIRK33">[docs]</a><span class="k">class</span> <span class="nc">DIRK33</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DIRK33, 3-stage, 3rd order, L-stable</span>
<span class="sd">    Diagonally Implicit Runge Kutta method</span>

<span class="sd">    From DIRK(3,4,3) IMEX scheme in Ascher et al. (1997)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.4358665215</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gamma</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">gamma</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">4.0</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gamma</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">gamma</span> <span class="o">+</span> <span class="mf">5.0</span><span class="o">/</span><span class="mf">4.0</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="n">gamma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[(</span><span class="mi">1</span><span class="o">-</span><span class="n">gamma</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">gamma</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">gamma</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span></div>


<div class="viewcode-block" id="DIRK43"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.DIRK43">[docs]</a><span class="k">class</span> <span class="nc">DIRK43</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DIRK43, 4-stage, 3rd order, L-stable</span>
<span class="sd">    Diagonally Implicit Runge Kutta method</span>

<span class="sd">    From DIRK(4,4,3) IMEX scheme in Ascher et al. (1997)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span></div>


<div class="viewcode-block" id="DIRKLSPUM2"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.DIRKLSPUM2">[docs]</a><span class="k">class</span> <span class="nc">DIRKLSPUM2</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DIRKLSPUM2, 3-stage, 2nd order, L-stable</span>
<span class="sd">    Diagonally Implicit Runge Kutta method</span>

<span class="sd">    From IMEX RK scheme (17) in Higureras et al. (2014).</span>

<span class="sd">    [1] Higueras et al (2014). Optimized strong stability preserving IMEX</span>
<span class="sd">        Runge-Kutta methods. Journal of Computational and Applied</span>
<span class="sd">        Mathematics 272(2014) 116-140.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">205.0</span><span class="o">/</span><span class="mf">462.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">2033.0</span><span class="o">/</span><span class="mf">4620.0</span><span class="p">,</span> <span class="mf">21.0</span><span class="o">/</span><span class="mf">110.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">24.0</span><span class="o">/</span><span class="mf">55.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">,</span> <span class="mf">289.0</span><span class="o">/</span><span class="mf">462.0</span><span class="p">,</span> <span class="mf">751.0</span><span class="o">/</span><span class="mf">924.0</span><span class="p">]</span></div>


<div class="viewcode-block" id="ERKLSPUM2"><a class="viewcode-back" href="../../thetis.html#thetis.timeintegrator.ERKLSPUM2">[docs]</a><span class="k">class</span> <span class="nc">ERKLSPUM2</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ERKLSPUM2, 3-stage, 2nd order</span>
<span class="sd">    Explicit Runge Kutta method</span>

<span class="sd">    From IMEX RK scheme (17) in Higureras et al. (2014).</span>

<span class="sd">    [1] Higueras et al (2014). Optimized strong stability preserving IMEX</span>
<span class="sd">        Runge-Kutta methods. Journal of Computational and Applied</span>
<span class="sd">        Mathematics 272(2014) 116-140.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">5.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">11.0</span><span class="o">/</span><span class="mf">24.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="o">/</span><span class="mf">24.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">24.0</span><span class="o">/</span><span class="mf">55.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">5.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">]</span></div>
</pre></div>

          </div>
        </div>
      </div>
    </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Tuomas Karna et al..
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.6.
    </div>
  </body>
</html>