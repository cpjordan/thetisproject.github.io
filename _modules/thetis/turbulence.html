<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>thetis.turbulence &#8212; Thetis 0+untagged.771.gd639bf8 documentation</title>
    
    <link rel="stylesheet" href="../../_static/thetis.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0+untagged.771.gd639bf8',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

<!-- <link rel="stylesheet" href="../../_static/featured.css"> -->


<link rel="shortcut icon" href="../../_static/icon_thetis.ico" />


  </head>
  <body role="document">
<div class="wrapper">
  <a href="../../index.html"><img src="../../_static/banner.png" height="180px" alt="Thetis Project Banner" /></a>
  <div id="access">
    <div class="menu">
      <ul>
        <li class="page_item"><a href="../../documentation.html" title="Thetis documentation">Documentation</a></li>
        <li class="page_item"><a href="../../download.html" title="Install Thetis">Download</a></li>
        <li class="page_item"><a href="../../team.html" title="Development team">Team</a></li>
        <li class="page_item"><a href="../../publications.html" title="Publications">Publications</a></li>
        <li class="page_item"><a href="../../funding.html" title="Our financial supporters">Funding</a></li>
        <li class="page_item"><a href="../../contact.html" title="Getting in touch">Contact</a></li>
        <li class="page_item"><a href="https://github.com/thetisproject/thetis" title="Thetis source on GitHub">GitHub</a></li>
        <li class="page_item"><a href="https://travis-ci.org/thetisproject/thetis" title="Thetis on Travis">Travis</a></li>
      </ul>
    </div><!-- .menu -->
  </div><!-- #access -->
</div><!-- #wrapper -->


    <div class="document">
    <div class="_modules/thetis/turbulence">
      
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thetis.turbulence</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Generic Length Scale Turbulence Closure model [1].</span>

<span class="sd">This model solves two dynamic equations, for turbulent kinetic energy (tke, k)</span>
<span class="sd">and additional variable psi.</span>

<span class="sd">dk/dt + \nabla_h(uv*k) + d(w*k)/dz = d/dz(\nu_h/\sigma_k dk/dz) + P + B - eps</span>
<span class="sd">dpsi/dt + \nabla_h(uv*psi) + d(w*psi)/dz = d/dz(\nu_h/\sigma_psi dpsi/dz) +</span>
<span class="sd">   psi/k*(c1*P + c3*B - c2*eps*f_wall)</span>

<span class="sd">P = viscosity M**2             (production)</span>
<span class="sd">B = - diffusivity N**2         (byoyancy production)</span>
<span class="sd">M**2 = (du/dz)**2 + (dv/dz)**2 (shear frequency)</span>
<span class="sd">N**2 = -g\rho_0 (drho/dz)      (buoyancy frequency)</span>

<span class="sd">The additional variable is defined as</span>
<span class="sd">psi = (cmu0)**p * k**m * l**n</span>
<span class="sd">where p, m, n parameters and cmu0 is an empirical constant.</span>

<span class="sd">dpsi/dt + \nabla_h(uv*psi) + d(w*psi)dz = d/dz(\nu_h/\sigma_psi dpsi/dz) +</span>
<span class="sd">   psi/k*(c1*P + c3*B - c2*eps*f_wall)</span>


<span class="sd">Parameter c3 takes value c3_minus in stably stratified flows and c3_plus in</span>
<span class="sd">unstably stratified cases.</span>

<span class="sd">Turbulent length scale is obtained diagnostically as</span>
<span class="sd">l = (cmu0)**3 * k**(3/2) * eps**(-1)</span>

<span class="sd">TKE dissipation rate is given by</span>
<span class="sd">eps = (cmu0)**(3+p/n)*tke**(3/2+m/n)*psi**(-1/n)</span>

<span class="sd">Finally vertical eddy viscosity and diffusivity are obtained as</span>

<span class="sd">viscosity = c*sqrt(2*k)*l*stability_func_m</span>
<span class="sd">diffusivity = c*sqrt(2*k)*l*stability_func_rho</span>

<span class="sd">Stability functions are defined as obtained from [2] or [3].</span>
<span class="sd">Implementation follows [4].</span>

<span class="sd">[1] Umlauf, L. and Burchard, H. (2003). A generic length-scale equation for</span>
<span class="sd">    geophysical turbulence models. Journal of Marine Research, 61:235--265(31).</span>
<span class="sd">    http://dx.doi.org/10.1357/002224003322005087</span>

<span class="sd">[2] Kantha, L. H. and Clayson, C. A. (1994). An improved mixed layer model for</span>
<span class="sd">    geophysical applications. Journal of Geophysical Research: Oceans,</span>
<span class="sd">    99(C12):25235--25266.</span>
<span class="sd">    http://dx.doi.org/10.1029/94JC02257</span>

<span class="sd">[3] Canuto et al. (2001). Ocean Turbulence. Part I: One-Point Closure Model -</span>
<span class="sd">    Momentum and Heat Vertical Diffusivities. Journal of Physical Oceanography,</span>
<span class="sd">    31(6):1413-1426.</span>
<span class="sd">    http://dx.doi.org/10.1175/1520-0485(2001)031</span>

<span class="sd">[4] Warner et al. (2005). Performance of four turbulence closure models</span>
<span class="sd">    implemented using a generic length scale method. Ocean Modelling,</span>
<span class="sd">    8(1-2):81--113.</span>
<span class="sd">    http://dx.doi.org/10.1016/j.ocemod.2003.12.003</span>

<span class="sd">[5] Umlauf, L. and Burchard, H. (2005). Second-order turbulence closure models</span>
<span class="sd">    for geophysical boundary layers. A review of recent work. Continental Shelf</span>
<span class="sd">    Research, 25(7-8):795--827.</span>
<span class="sd">    http://dx.doi.org/10.1016/j.csr.2004.08.004</span>

<span class="sd">Tuomas Karna 2015-09-07</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">absolute_import</span>
<span class="kn">from</span> <span class="nn">.tracer_eq</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.utility</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.stability_functions</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.log</span> <span class="k">import</span> <span class="o">*</span>


<div class="viewcode-block" id="GLSModelOptions"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.GLSModelOptions">[docs]</a><span class="k">class</span> <span class="nc">GLSModelOptions</span><span class="p">(</span><span class="n">AttrDict</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Options for Generic Lenght Scale turbulence model</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize with default options</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GLSModelOptions</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">closure_name</span> <span class="o">=</span> <span class="s1">&#39;k-epsilon&#39;</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        str: name of common closures</span>

<span class="sd">        &#39;k-epsilon&#39;: k-epsilon setup</span>
<span class="sd">        &#39;k-omega&#39;: k-epsilon setup</span>
<span class="sd">        &#39;gls-a&#39;: Generic Length Scale setup A</span>

<span class="sd">        Sets default values for parameters p, m, n, schmidt_nb_tke, schmidt_nb_psi, c1, c2, c3_plus, c3_minus,</span>
<span class="sd">        f_wall, k_min, psi_min</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stability_name</span> <span class="o">=</span> <span class="s1">&#39;CA&#39;</span>
        <span class="sd">&quot;&quot;&quot;str: name of used stability function family</span>

<span class="sd">        &#39;CA&#39;: Canuto A</span>
<span class="sd">        &#39;CB&#39;: Canuto B</span>
<span class="sd">        &#39;KC&#39;: Kantha-Clayson</span>
<span class="sd">        &#39;CH&#39;: Cheng</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p</span> <span class="o">=</span> <span class="mf">3.0</span>
        <span class="sd">&quot;&quot;&quot;float: parameter p for the definition of psi&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m</span> <span class="o">=</span> <span class="mf">1.5</span>
        <span class="sd">&quot;&quot;&quot;float: parameter m for the definition of psi&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="sd">&quot;&quot;&quot;float: parameter n for the definition of psi&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schmidt_nb_tke</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="sd">&quot;&quot;&quot;float: turbulent kinetic energy Schmidt number&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schmidt_nb_psi</span> <span class="o">=</span> <span class="mf">1.3</span>
        <span class="sd">&quot;&quot;&quot;float: psi Schmidt number&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmu0</span> <span class="o">=</span> <span class="mf">0.5477</span>
        <span class="sd">&quot;&quot;&quot;float: cmu0 parameter&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_cmu0</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="sd">&quot;&quot;&quot;bool: compute cmu0 from stability function parameters&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c1</span> <span class="o">=</span> <span class="mf">1.44</span>
        <span class="sd">&quot;&quot;&quot;float: c1 parameter for Psi equations&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c2</span> <span class="o">=</span> <span class="mf">1.92</span>
        <span class="sd">&quot;&quot;&quot;float: c2 parameter for Psi equations&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c3_minus</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.52</span>
        <span class="sd">&quot;&quot;&quot;float: c3 parameter for Psi equations, stable stratification&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c3_plus</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="sd">&quot;&quot;&quot;float: c3 parameter for Psi equations, unstable stratification&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_c3_minus</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="sd">&quot;&quot;&quot;bool: compute c3_minus from ri_st</span>

<span class="sd">        ri_st is the steady state gradient Richardson number&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f_wall</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="sd">&quot;&quot;&quot;float: wall function parameter&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ri_st</span> <span class="o">=</span> <span class="mf">0.25</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="n">physical_constants</span><span class="p">[</span><span class="s1">&#39;von_karman&#39;</span><span class="p">]</span>
        <span class="sd">&quot;&quot;&quot;float: steady state gradient Richardson number</span>

<span class="sd">        Used to compute c3_minus&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_kappa</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="sd">&quot;&quot;&quot;bool: compute von Karman constant from psi Schmidt number&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_min</span> <span class="o">=</span> <span class="mf">3.7e-8</span>
        <span class="sd">&quot;&quot;&quot;float: minimum value for turbulent kinetic energy&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi_min</span> <span class="o">=</span> <span class="mf">1.0e-10</span>
        <span class="sd">&quot;&quot;&quot;float: minimum value for psi&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps_min</span> <span class="o">=</span> <span class="mf">1.0e-10</span>
        <span class="sd">&quot;&quot;&quot;float: minimum value for epsilon&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">len_min</span> <span class="o">=</span> <span class="mf">1.0e-10</span>
        <span class="sd">&quot;&quot;&quot;float: minimum value for turbulent lenght scale&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_len_min</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="sd">&quot;&quot;&quot;bool: compute min_len from k_min and psi_min&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_psi_min</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="sd">&quot;&quot;&quot;bool: compute psi_len from k_min and eps_min&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">visc_min</span> <span class="o">=</span> <span class="mf">1.0e-8</span>
        <span class="sd">&quot;&quot;&quot;float: minimum value for eddy viscosity&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diff_min</span> <span class="o">=</span> <span class="mf">1.0e-8</span>
        <span class="sd">&quot;&quot;&quot;float: minimum value for eddy diffusivity&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">galperin_lim</span> <span class="o">=</span> <span class="mf">0.56</span>
        <span class="sd">&quot;&quot;&quot;float: Galperin lenght scale limitation parameter&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">limit_len</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="sd">&quot;&quot;&quot;bool: apply Galperin lenght scale limit&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_psi</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="sd">&quot;&quot;&quot;bool: apply Galperin lenght scale limit on psi&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_eps</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="sd">&quot;&quot;&quot;bool: apply Galperin lenght scale limit on epsilon&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">limit_len_min</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="sd">&quot;&quot;&quot;bool: limit minimum turbulent length scale to len_min&quot;&quot;&quot;</span>

<div class="viewcode-block" id="GLSModelOptions.apply_defaults"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.GLSModelOptions.apply_defaults">[docs]</a>    <span class="k">def</span> <span class="nf">apply_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">closure_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Applies default parameters for given closure name.&quot;&quot;&quot;</span>

        <span class="c1"># standard values for different closures</span>
        <span class="c1"># from [3] tables 1 and 2</span>
        <span class="n">kepsilon</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                    <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">,</span>
                    <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="s1">&#39;cmu0&#39;</span><span class="p">:</span> <span class="mf">0.5477</span><span class="p">,</span>
                    <span class="s1">&#39;schmidt_nb_tke&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="s1">&#39;schmidt_nb_psi&#39;</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>
                    <span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="mf">1.44</span><span class="p">,</span>
                    <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="mf">1.92</span><span class="p">,</span>
                    <span class="s1">&#39;c3_plus&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="s1">&#39;c3_minus&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.52</span><span class="p">,</span>
                    <span class="s1">&#39;f_wall&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                    <span class="s1">&#39;k_min&#39;</span><span class="p">:</span> <span class="mf">3.7e-8</span><span class="p">,</span>
                    <span class="s1">&#39;psi_min&#39;</span><span class="p">:</span> <span class="mf">1.0e-10</span><span class="p">,</span>
                    <span class="s1">&#39;closure_name&#39;</span><span class="p">:</span> <span class="s1">&#39;k-epsilon&#39;</span><span class="p">,</span>
                    <span class="p">}</span>
        <span class="n">komega</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                  <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span>
                  <span class="s1">&#39;cmu0&#39;</span><span class="p">:</span> <span class="mf">0.5477</span><span class="p">,</span>
                  <span class="s1">&#39;schmidt_nb_tke&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                  <span class="s1">&#39;schmidt_nb_psi&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
                  <span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="mf">0.555</span><span class="p">,</span>
                  <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="mf">0.833</span><span class="p">,</span>
                  <span class="s1">&#39;c3_plus&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                  <span class="s1">&#39;c3_minus&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.52</span><span class="p">,</span>
                  <span class="s1">&#39;f_wall&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
                  <span class="s1">&#39;k_min&#39;</span><span class="p">:</span> <span class="mf">3.7e-8</span><span class="p">,</span>
                  <span class="s1">&#39;eps_min&#39;</span><span class="p">:</span> <span class="mf">1.0e-10</span><span class="p">,</span>
                  <span class="s1">&#39;psi_min&#39;</span><span class="p">:</span> <span class="mf">1.0e-10</span><span class="p">,</span>
                  <span class="s1">&#39;closure_name&#39;</span><span class="p">:</span> <span class="s1">&#39;k-omega&#39;</span><span class="p">,</span>
                  <span class="p">}</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;p&#39;</span><span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
               <span class="s1">&#39;m&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
               <span class="s1">&#39;n&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mf">0.67</span><span class="p">,</span>
               <span class="s1">&#39;cmu0&#39;</span><span class="p">:</span> <span class="mf">0.5477</span><span class="p">,</span>
               <span class="s1">&#39;schmidt_nb_tke&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">,</span>
               <span class="s1">&#39;schmidt_nb_psi&#39;</span><span class="p">:</span> <span class="mf">1.07</span><span class="p">,</span>
               <span class="s1">&#39;c1&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
               <span class="s1">&#39;c2&#39;</span><span class="p">:</span> <span class="mf">1.22</span><span class="p">,</span>
               <span class="s1">&#39;c3_plus&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
               <span class="s1">&#39;c3_minus&#39;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span>
               <span class="s1">&#39;f_wall&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
               <span class="s1">&#39;k_min&#39;</span><span class="p">:</span> <span class="mf">3.7e-8</span><span class="p">,</span>
               <span class="s1">&#39;eps_min&#39;</span><span class="p">:</span> <span class="mf">1.0e-10</span><span class="p">,</span>
               <span class="s1">&#39;psi_min&#39;</span><span class="p">:</span> <span class="mf">2.0e-7</span><span class="p">,</span>
               <span class="s1">&#39;closure_name&#39;</span><span class="p">:</span> <span class="s1">&#39;gen&#39;</span><span class="p">,</span>
               <span class="p">}</span>
        <span class="k">if</span> <span class="n">closure_name</span> <span class="o">==</span> <span class="s1">&#39;k-epsilon&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kepsilon</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">closure_name</span> <span class="o">==</span> <span class="s1">&#39;k-omega&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">komega</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">closure_name</span> <span class="o">==</span> <span class="s1">&#39;gen&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span></div>

<div class="viewcode-block" id="GLSModelOptions.print_summary"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.GLSModelOptions.print_summary">[docs]</a>    <span class="k">def</span> <span class="nf">print_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prints all defined parameters and their values.&quot;&quot;&quot;</span>
        <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;GLS Turbulence model parameters&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;  </span><span class="si">{:16s}</span><span class="s1"> : </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span></div></div>


<div class="viewcode-block" id="set_func_min_val"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.set_func_min_val">[docs]</a><span class="k">def</span> <span class="nf">set_func_min_val</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">minval</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets a minimum value to a function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">minval</span><span class="p">]</span> <span class="o">=</span> <span class="n">minval</span></div>


<div class="viewcode-block" id="set_func_max_val"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.set_func_max_val">[docs]</a><span class="k">def</span> <span class="nf">set_func_max_val</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">maxval</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Sets a minimum value to a function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">f</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span> <span class="o">&gt;</span> <span class="n">maxval</span><span class="p">]</span> <span class="o">=</span> <span class="n">maxval</span></div>


<div class="viewcode-block" id="P1Average"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.P1Average">[docs]</a><span class="k">class</span> <span class="nc">P1Average</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes a DP field and computes nodal averages and stores in P1 field.</span>

<span class="sd">    Source must be either a p0 or p1dg function.</span>
<span class="sd">    The averaging operation is both mass conservative and positivity preserving.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p1dg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p0</span> <span class="o">=</span> <span class="n">p0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p1</span> <span class="o">=</span> <span class="n">p1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p1dg</span> <span class="o">=</span> <span class="n">p1dg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol_p1</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;nodal volume p1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vol_p1dg</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p1dg</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;nodal volume p1dg&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_volumes</span><span class="p">()</span>

<div class="viewcode-block" id="P1Average.update_volumes"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.P1Average.update_volumes">[docs]</a>    <span class="k">def</span> <span class="nf">update_volumes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">assemble</span><span class="p">(</span><span class="n">TestFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_p1</span><span class="p">)</span>
        <span class="n">assemble</span><span class="p">(</span><span class="n">TestFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p1dg</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vol_p1dg</span><span class="p">)</span></div>

<div class="viewcode-block" id="P1Average.apply"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.P1Average.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">solution</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span>
        <span class="k">assert</span> <span class="n">source</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">p0</span> <span class="ow">or</span> <span class="n">source</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1dg</span>
        <span class="n">source_is_p0</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">p0</span>

        <span class="n">source_str</span> <span class="o">=</span> <span class="s1">&#39;source[0][c]&#39;</span> <span class="k">if</span> <span class="n">source_is_p0</span> <span class="k">else</span> <span class="s1">&#39;source[d][c]&#39;</span>
        <span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="n">fs_source</span> <span class="o">=</span> <span class="n">source</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Kernel</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            void my_kernel(double **p1_average, double **source, double **vol_p1, double **vol_p1dg) {</span>
<span class="s2">                for ( int d = 0; d &lt; </span><span class="si">%(nodes)d</span><span class="s2">; d++ ) {</span>
<span class="s2">                    for ( int c = 0; c &lt; </span><span class="si">%(func_dim)d</span><span class="s2">; c++ ) {</span>
<span class="s2">                        p1_average[d][c] += </span><span class="si">%(source_str)s</span><span class="s2"> * vol_p1dg[d][c] / vol_p1[d][c];</span>
<span class="s2">                    }</span>
<span class="s2">                }</span>
<span class="s2">            }&quot;&quot;&quot;</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">cell_node_map</span><span class="p">()</span><span class="o">.</span><span class="n">arity</span><span class="p">,</span>
                    <span class="s1">&#39;func_dim&#39;</span><span class="p">:</span> <span class="n">solution</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span><span class="o">.</span><span class="n">dim</span><span class="p">,</span>
                    <span class="s1">&#39;source_str&#39;</span><span class="p">:</span> <span class="n">source_str</span><span class="p">},</span>
            <span class="s1">&#39;my_kernel&#39;</span><span class="p">)</span>

        <span class="n">op2</span><span class="o">.</span><span class="n">par_loop</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span><span class="o">.</span><span class="n">cell_set</span><span class="p">,</span>
            <span class="n">solution</span><span class="o">.</span><span class="n">dat</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">WRITE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="o">.</span><span class="n">cell_node_map</span><span class="p">()),</span>
            <span class="n">source</span><span class="o">.</span><span class="n">dat</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">READ</span><span class="p">,</span> <span class="n">fs_source</span><span class="o">.</span><span class="n">cell_node_map</span><span class="p">()),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vol_p1</span><span class="o">.</span><span class="n">dat</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">READ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1</span><span class="o">.</span><span class="n">cell_node_map</span><span class="p">()),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vol_p1dg</span><span class="o">.</span><span class="n">dat</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">READ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">p1dg</span><span class="o">.</span><span class="n">cell_node_map</span><span class="p">()),</span>
            <span class="n">iterate</span><span class="o">=</span><span class="n">op2</span><span class="o">.</span><span class="n">ALL</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="VerticalGradSolver"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.VerticalGradSolver">[docs]</a><span class="k">class</span> <span class="nc">VerticalGradSolver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes vertical gradient in the weak sense.</span>

<span class="sd">    :arg source: A :class:`Function` or expression to differentiate.</span>
<span class="sd">    :arg source: A :class:`Function` where the solution will be stored.</span>
<span class="sd">        Must be in P0 space.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">solver_parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">solver_parameters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;ksponly&#39;</span><span class="p">)</span>
        <span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;ksp_type&#39;</span><span class="p">,</span> <span class="s1">&#39;preonly&#39;</span><span class="p">)</span>
        <span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;pc_type&#39;</span><span class="p">,</span> <span class="s1">&#39;bjacobi&#39;</span><span class="p">)</span>
        <span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;sub_ksp_type&#39;</span><span class="p">,</span> <span class="s1">&#39;preonly&#39;</span><span class="p">)</span>
        <span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;sub_pc_type&#39;</span><span class="p">,</span> <span class="s1">&#39;ilu&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">solution</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span>

        <span class="c1"># weak gradient evaluator</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">tri</span> <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">normal</span> <span class="o">=</span> <span class="n">FacetNormal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">tri</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span>
        <span class="n">l</span> <span class="o">=</span> <span class="o">-</span><span class="n">inner</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">Dx</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span><span class="o">*</span><span class="n">dx</span>
        <span class="n">l</span> <span class="o">+=</span> <span class="n">avg</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">jump</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">normal</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="n">dS_h</span>
        <span class="n">l</span> <span class="o">+=</span> <span class="n">p</span><span class="o">*</span><span class="n">test</span><span class="o">*</span><span class="n">normal</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">ds_t</span> <span class="o">+</span> <span class="n">ds_b</span><span class="p">)</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">LinearVariationalProblem</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span> <span class="n">constant_jacobian</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weak_grad_solver</span> <span class="o">=</span> <span class="n">LinearVariationalSolver</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="n">solver_parameters</span><span class="p">)</span>

<div class="viewcode-block" id="VerticalGradSolver.solve"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.VerticalGradSolver.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weak_grad_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="SmoothVerticalGradSolver"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.SmoothVerticalGradSolver">[docs]</a><span class="k">class</span> <span class="nc">SmoothVerticalGradSolver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes vertical gradient in a smooth(er) way.</span>

<span class="sd">    :arg source: A :class:`Function` or expression to differentiate.</span>
<span class="sd">    :arg source: A :class:`Function` where the solution will be stored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">solution</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span>

        <span class="n">p0</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DP&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vfamily</span><span class="o">=</span><span class="s1">&#39;DP&#39;</span><span class="p">,</span> <span class="n">vdegree</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span> <span class="o">==</span> <span class="n">p0</span><span class="p">,</span> <span class="s1">&#39;solution must be in p0&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">source_p0</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;p0 source&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradient_p0</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;p0 gradient&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p0_interpolator</span> <span class="o">=</span> <span class="n">Interpolator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source_p0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p0_grad_solver</span> <span class="o">=</span> <span class="n">VerticalGradSolver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source_p0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_solver</span> <span class="o">=</span> <span class="n">VerticalGradSolver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_p0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">p0_copy_kernel</span> <span class="o">=</span> <span class="n">op2</span><span class="o">.</span><span class="n">Kernel</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            void my_kernel(double **gradient, double **source) {</span>
<span class="s2">                gradient[0][0] = source[0][0];</span>
<span class="s2">            }&quot;&quot;&quot;</span><span class="p">,</span> <span class="s1">&#39;my_kernel&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="SmoothVerticalGradSolver.solve"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.SmoothVerticalGradSolver.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># interpolate p1dg to prism centers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p0_interpolator</span><span class="o">.</span><span class="n">interpolate</span><span class="p">()</span>
        <span class="c1"># compute weak gradine from source_p0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">p0_grad_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="c1"># compute weak gradient directly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grad_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="c1"># compute mean of the two</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">gradient_p0</span><span class="p">))</span>
        <span class="c1"># replace top/bottom values with weak gradient</span>
        <span class="c1"># FIXME how to combine ON_TOP + ON_BOTTOM in single call?</span>
        <span class="n">op2</span><span class="o">.</span><span class="n">par_loop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p0_copy_kernel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">cell_set</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">dat</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">WRITE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">cell_node_map</span><span class="p">()),</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">gradient_p0</span><span class="o">.</span><span class="n">dat</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">READ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">cell_node_map</span><span class="p">()),</span>
                     <span class="n">iterate</span><span class="o">=</span><span class="n">op2</span><span class="o">.</span><span class="n">ON_TOP</span><span class="p">)</span>
        <span class="n">op2</span><span class="o">.</span><span class="n">par_loop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">p0_copy_kernel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">cell_set</span><span class="p">,</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">dat</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">WRITE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">cell_node_map</span><span class="p">()),</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">gradient_p0</span><span class="o">.</span><span class="n">dat</span><span class="p">(</span><span class="n">op2</span><span class="o">.</span><span class="n">READ</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">cell_node_map</span><span class="p">()),</span>
                     <span class="n">iterate</span><span class="o">=</span><span class="n">op2</span><span class="o">.</span><span class="n">ON_BOTTOM</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ShearFrequencySolver"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.ShearFrequencySolver">[docs]</a><span class="k">class</span> <span class="nc">ShearFrequencySolver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes vertical shear frequency squared form the given horizontal</span>
<span class="sd">    velocity field.</span>

<span class="sd">    M^2 = du/dz^2 + dv/dz^2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">mv</span><span class="p">,</span> <span class="n">mu_tmp</span><span class="p">,</span> <span class="n">minval</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mv</span> <span class="o">=</span> <span class="n">mv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span> <span class="o">=</span> <span class="n">m2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu_tmp</span> <span class="o">=</span> <span class="n">mu_tmp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minval</span> <span class="o">=</span> <span class="n">minval</span>
        <span class="c1"># relaxation coefficient between old and new mu or mv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relaxation</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var_solvers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i_comp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">VerticalGradSolver</span><span class="p">(</span><span class="n">uv</span><span class="p">[</span><span class="n">i_comp</span><span class="p">],</span> <span class="n">mu_tmp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_solvers</span><span class="p">[</span><span class="n">i_comp</span><span class="p">]</span> <span class="o">=</span> <span class="n">solver</span>

<div class="viewcode-block" id="ShearFrequencySolver.solve"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.ShearFrequencySolver.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_solve</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">timed_stage</span><span class="p">(</span><span class="s1">&#39;shear_freq_solv&#39;</span><span class="p">):</span>
            <span class="n">mu_comp</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mv</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i_comp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var_solvers</span><span class="p">[</span><span class="n">i_comp</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
                <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relaxation</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">init_solve</span> <span class="k">else</span> <span class="mf">1.0</span>
                <span class="n">mu_comp</span><span class="p">[</span><span class="n">i_comp</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">gamma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mu_tmp</span> <span class="o">+</span>
                                       <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">)</span><span class="o">*</span><span class="n">mu_comp</span><span class="p">[</span><span class="n">i_comp</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">m2</span> <span class="o">+=</span> <span class="n">mu_comp</span><span class="p">[</span><span class="n">i_comp</span><span class="p">]</span><span class="o">*</span><span class="n">mu_comp</span><span class="p">[</span><span class="n">i_comp</span><span class="p">]</span>
            <span class="c1"># crop small/negative values</span>
            <span class="n">set_func_min_val</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">minval</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BuoyFrequencySolver"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.BuoyFrequencySolver">[docs]</a><span class="k">class</span> <span class="nc">BuoyFrequencySolver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Computes buoyancy frequency squared form the given horizontal</span>
<span class="sd">    velocity field.</span>

<span class="sd">    N^2 = -g/rho0 drho/dz</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n2_tmp</span><span class="p">,</span> <span class="n">minval</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_no_op</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">rho</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_no_op</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_op</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">n2</span> <span class="o">=</span> <span class="n">n2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n2_tmp</span> <span class="o">=</span> <span class="n">n2_tmp</span>
            <span class="c1"># relaxation coefficient between old and new mu or mv</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">relaxation</span> <span class="o">=</span> <span class="mf">1.0</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">var_solvers</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">g</span> <span class="o">=</span> <span class="n">physical_constants</span><span class="p">[</span><span class="s1">&#39;g_grav&#39;</span><span class="p">]</span>
            <span class="n">rho0</span> <span class="o">=</span> <span class="n">physical_constants</span><span class="p">[</span><span class="s1">&#39;rho0&#39;</span><span class="p">]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="o">-</span><span class="n">g</span><span class="o">/</span><span class="n">rho0</span> <span class="o">*</span> <span class="n">rho</span>
            <span class="n">solver</span> <span class="o">=</span> <span class="n">VerticalGradSolver</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2_tmp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">var_solver</span> <span class="o">=</span> <span class="n">solver</span>

<div class="viewcode-block" id="BuoyFrequencySolver.solve"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.BuoyFrequencySolver.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_solve</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">timed_stage</span><span class="p">(</span><span class="s1">&#39;buoy_freq_solv&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_no_op</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">var_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
                <span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relaxation</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">init_solve</span> <span class="k">else</span> <span class="mf">1.0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">gamma</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">n2_tmp</span> <span class="o">+</span>
                               <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">gamma</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GenericLengthScaleModel"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.GenericLengthScaleModel">[docs]</a><span class="k">class</span> <span class="nc">GenericLengthScaleModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic Length Scale turbulence closure model implementation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solver</span><span class="p">,</span> <span class="n">k_field</span><span class="p">,</span> <span class="n">psi_field</span><span class="p">,</span> <span class="n">uv_field</span><span class="p">,</span> <span class="n">rho_field</span><span class="p">,</span>
                 <span class="n">l_field</span><span class="p">,</span> <span class="n">epsilon_field</span><span class="p">,</span>
                 <span class="n">eddy_diffusivity</span><span class="p">,</span> <span class="n">eddy_viscosity</span><span class="p">,</span>
                 <span class="n">n2</span><span class="p">,</span> <span class="n">m2</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize GLS model</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>

<span class="sd">        k_field : Function</span>
<span class="sd">            turbulent kinetic energy (TKE) field</span>
<span class="sd">        psi_field : Function</span>
<span class="sd">            field for the accompanying GLS variable psi</span>
<span class="sd">        uv_field : Function</span>
<span class="sd">            horizontal velocity field</span>
<span class="sd">        rho_field : Function</span>
<span class="sd">            water density field</span>
<span class="sd">        epsilon_field : Function</span>
<span class="sd">            TKE dissipation rate field</span>
<span class="sd">        l_field : Function</span>
<span class="sd">            turbulence length scale field</span>
<span class="sd">        eddy_viscosity, eddy_diffusivity : Function</span>
<span class="sd">            eddy viscosity/diffusivity fields</span>
<span class="sd">        n2, m2 : Function</span>
<span class="sd">            buoyancy and vertical shear frequency squared</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">solver</span>
        <span class="c1"># 3d model fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">uv_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="o">=</span> <span class="n">rho_field</span>
        <span class="c1"># prognostic fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi</span> <span class="o">=</span> <span class="n">psi_field</span>
        <span class="c1"># diagnostic fields</span>
        <span class="c1"># NOTE redundant for k-epsilon model where psi==epsilon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span> <span class="o">=</span> <span class="n">epsilon_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="n">l_field</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viscosity</span> <span class="o">=</span> <span class="n">eddy_viscosity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diffusivity</span> <span class="o">=</span> <span class="n">eddy_diffusivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2</span> <span class="o">=</span> <span class="n">n2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m2</span> <span class="o">=</span> <span class="n">m2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu_tmp</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tmp Shear frequency&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Shear frequency X&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mv</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Shear frequency Y&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2_tmp</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tmp buoyancy frequency&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2_pos</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;positive buoyancy frequency&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2_neg</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;negative buoyancy frequency&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_smooth_eddy_viscosity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viscosity_native</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;GLS viscosity&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diffusivity_native</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                                               <span class="n">name</span><span class="o">=</span><span class="s1">&#39;GLS diffusivity&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">p1_averager</span> <span class="o">=</span> <span class="n">P1Average</span><span class="p">(</span><span class="n">solver</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P0</span><span class="p">,</span>
                                         <span class="n">solver</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1</span><span class="p">,</span>
                                         <span class="n">solver</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DG</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viscosity_native</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">viscosity</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diffusivity_native</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffusivity</span>

        <span class="c1"># parameter to mix old and new viscosity values (1 =&gt; new only)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">relaxation</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">GLSModelOptions</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
        <span class="n">stability_name</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">stability_name</span>
        <span class="n">stab_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lim_alpha_shear&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="s1">&#39;lim_alpha_buoy&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="s1">&#39;smooth_alpha_buoy_lim&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">stability_name</span> <span class="o">==</span> <span class="s1">&#39;KC&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stability_func</span> <span class="o">=</span> <span class="n">StabilityFunctionKanthaClayson</span><span class="p">(</span><span class="o">**</span><span class="n">stab_args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stability_name</span> <span class="o">==</span> <span class="s1">&#39;CA&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stability_func</span> <span class="o">=</span> <span class="n">StabilityFunctionCanutoA</span><span class="p">(</span><span class="o">**</span><span class="n">stab_args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stability_name</span> <span class="o">==</span> <span class="s1">&#39;CB&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stability_func</span> <span class="o">=</span> <span class="n">StabilityFunctionCanutoB</span><span class="p">(</span><span class="o">**</span><span class="n">stab_args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">stability_name</span> <span class="o">==</span> <span class="s1">&#39;CH&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stability_func</span> <span class="o">=</span> <span class="n">StabilityFunctionCheng</span><span class="p">(</span><span class="o">**</span><span class="n">stab_args</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unknown stability function type: &#39;</span> <span class="o">+</span>
                            <span class="n">stability_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">compute_cmu0</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">cmu0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stability_func</span><span class="o">.</span><span class="n">compute_cmu0</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">compute_kappa</span><span class="p">:</span>
            <span class="n">kappa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stability_func</span><span class="o">.</span><span class="n">compute_kappa</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">schmidt_nb_psi</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">c1</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">c2</span><span class="p">)</span>
            <span class="n">o</span><span class="o">.</span><span class="n">kappa</span> <span class="o">=</span> <span class="n">kappa</span>
            <span class="c1"># update mean flow model value as well</span>
            <span class="n">physical_constants</span><span class="p">[</span><span class="s1">&#39;von_karman&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">kappa</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">compute_c3_minus</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">c3_minus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stability_func</span><span class="o">.</span><span class="n">compute_c3_minus</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">c1</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">c2</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">ri_st</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">compute_psi_min</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">psi_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">cmu0</span><span class="o">**</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">+</span> <span class="n">o</span><span class="o">.</span><span class="n">p</span><span class="o">/</span><span class="n">o</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">o</span><span class="o">.</span><span class="n">k_min</span><span class="o">**</span><span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">o</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">o</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">o</span><span class="o">.</span><span class="n">eps_min</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">))</span><span class="o">**</span><span class="n">o</span><span class="o">.</span><span class="n">n</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">eps_min</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">cmu0</span><span class="o">**</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">+</span> <span class="n">o</span><span class="o">.</span><span class="n">p</span><span class="o">/</span><span class="n">o</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">o</span><span class="o">.</span><span class="n">k_min</span><span class="o">**</span><span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">o</span><span class="o">.</span><span class="n">m</span><span class="o">/</span><span class="n">o</span><span class="o">.</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">o</span><span class="o">.</span><span class="n">psi_min</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">o</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
        <span class="c1"># minimum length scale</span>
        <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">compute_len_min</span><span class="p">:</span>
            <span class="n">o</span><span class="o">.</span><span class="n">len_min</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">cmu0</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="n">o</span><span class="o">.</span><span class="n">k_min</span><span class="o">**</span><span class="mf">1.5</span> <span class="o">/</span> <span class="n">o</span><span class="o">.</span><span class="n">eps_min</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shear_frequency_solver</span> <span class="o">=</span> <span class="n">ShearFrequencySolver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mv</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">mu_tmp</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buoy_frequency_solver</span> <span class="o">=</span> <span class="n">BuoyFrequencySolver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rho</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="p">,</span>
                                                             <span class="bp">self</span><span class="o">.</span><span class="n">n2_tmp</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">print_summary</span><span class="p">()</span>

<div class="viewcode-block" id="GenericLengthScaleModel.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.GenericLengthScaleModel.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initializes fields&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2_pos</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n2_neg</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">init_solve</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postprocess</span><span class="p">()</span></div>

<div class="viewcode-block" id="GenericLengthScaleModel.preprocess"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.GenericLengthScaleModel.preprocess">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_solve</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To be called before evaluating the equations.</span>

<span class="sd">        Update all fields that depend on velocity and density.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># update m2 and N2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shear_frequency_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">init_solve</span><span class="o">=</span><span class="n">init_solve</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rho</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">buoy_frequency_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">init_solve</span><span class="o">=</span><span class="n">init_solve</span><span class="p">)</span>
            <span class="c1"># split to positive and negative parts</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n2_pos</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n2_neg</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
            <span class="n">pos_ix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">&gt;=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n2_pos</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">pos_ix</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">pos_ix</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">n2_neg</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">pos_ix</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">~</span><span class="n">pos_ix</span><span class="p">]</span></div>

<div class="viewcode-block" id="GenericLengthScaleModel.postprocess"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.GenericLengthScaleModel.postprocess">[docs]</a>    <span class="k">def</span> <span class="nf">postprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        To be called after evaluating the equations.</span>

<span class="sd">        Update all fields that depend on turbulence fields.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">timed_stage</span><span class="p">(</span><span class="s1">&#39;turb_postproc&#39;</span><span class="p">):</span>
            <span class="n">o</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span>
            <span class="n">cmu0</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">cmu0</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">p</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">n</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">m</span>

            <span class="c1"># limit k</span>
            <span class="n">set_func_min_val</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">k_min</span><span class="p">)</span>

            <span class="n">k_arr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>
            <span class="n">n2_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n2_pos</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>
            <span class="n">n2_pos_eps</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span>
            <span class="n">galp</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">galperin_lim</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">limit_psi</span><span class="p">:</span>
                <span class="c1"># impose Galperin limit on psi</span>
                <span class="c1"># psi^(1/n) &lt;= sqrt(0.56)* (cmu0)^(p/n) *k^(m/n+0.5)* n2^(-0.5)</span>
                <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">galp</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">cmu0</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">p</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span> <span class="o">*</span> <span class="n">k_arr</span><span class="o">**</span><span class="p">(</span><span class="n">m</span> <span class="o">/</span> <span class="n">n</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n2_pos</span> <span class="o">+</span> <span class="n">n2_pos_eps</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">))</span><span class="o">**</span><span class="n">n</span>
                <span class="k">if</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># impose max value</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># impose min value</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">set_func_min_val</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">psi_min</span><span class="p">)</span>

            <span class="c1"># udpate epsilon</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cmu0</span><span class="o">**</span><span class="p">(</span><span class="mf">3.0</span> <span class="o">+</span> <span class="n">p</span><span class="o">/</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">**</span><span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">m</span><span class="o">/</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">psi</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="n">n</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">limit_eps</span><span class="p">:</span>
                <span class="c1"># impose Galperin limit on eps</span>
                <span class="n">eps_min</span> <span class="o">=</span> <span class="n">cmu0</span><span class="o">**</span><span class="mf">3.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">galp</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">n2_pos</span><span class="p">)</span><span class="o">*</span><span class="n">k_arr</span>
                <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">eps_min</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># impose minimum value</span>
            <span class="c1"># FIXME this should not be need because psi is limited</span>
            <span class="n">set_func_min_val</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">eps_min</span><span class="p">)</span>

            <span class="c1"># update L</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">cmu0</span><span class="o">**</span><span class="mf">3.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">**</span><span class="p">(</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">limit_len_min</span><span class="p">:</span>
                <span class="n">set_func_min_val</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">len_min</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">o</span><span class="o">.</span><span class="n">limit_len</span><span class="p">:</span>
                <span class="c1"># Galperin length scale limitation</span>
                <span class="n">len_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">galp</span><span class="o">*</span><span class="n">k_arr</span><span class="o">/</span><span class="p">(</span><span class="n">n2_pos</span> <span class="o">+</span> <span class="n">n2_pos_eps</span><span class="p">))</span>
                <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">len_max</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">10.0</span><span class="p">:</span>
                <span class="n">warning</span><span class="p">(</span><span class="s1">&#39; * large L: </span><span class="si">{:f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

            <span class="c1"># update stability functions</span>
            <span class="n">s_m</span><span class="p">,</span> <span class="n">s_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stability_func</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m2</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">n2</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">epsilon</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="c1"># update diffusivity/viscosity</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[:])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>
            <span class="n">lam</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relaxation</span>
            <span class="n">new_visc</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">s_m</span><span class="o">/</span><span class="n">cmu0</span><span class="o">**</span><span class="mi">3</span>
            <span class="n">new_diff</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">s_h</span><span class="o">/</span><span class="n">cmu0</span><span class="o">**</span><span class="mi">3</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viscosity_native</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">lam</span><span class="o">*</span><span class="n">new_visc</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">lam</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">viscosity_native</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">diffusivity_native</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">lam</span><span class="o">*</span><span class="n">new_diff</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">lam</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">diffusivity_native</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[:]</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_smooth_eddy_viscosity</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p1_averager</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viscosity_native</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">viscosity</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">p1_averager</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diffusivity_native</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diffusivity</span><span class="p">)</span>
            <span class="n">set_func_min_val</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viscosity</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">visc_min</span><span class="p">)</span>
            <span class="n">set_func_min_val</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">diffusivity</span><span class="p">,</span> <span class="n">o</span><span class="o">.</span><span class="n">diff_min</span><span class="p">)</span></div></div>

            <span class="c1"># print_output(&#39;{:8s} {:10.3e} {:10.3e}&#39;.format(&#39;k&#39;, self.k.dat.data.min(), self.k.dat.data.max()))</span>
            <span class="c1"># print_output(&#39;{:8s} {:10.3e} {:10.3e}&#39;.format(&#39;eps&#39;, self.epsilon.dat.data.min(), self.epsilon.dat.data.max()))</span>
            <span class="c1"># print_output(&#39;{:8s} {:10.3e} {:10.3e}&#39;.format(&#39;L&#39;, self.l.dat.data.min(), self.l.dat.data.max()))</span>
            <span class="c1"># print_output(&#39;{:8s} {:10.3e} {:10.3e}&#39;.format(&#39;M2&#39;, self.m2.dat.data.min(), self.m2.dat.data.max()))</span>
            <span class="c1"># print_output(&#39;{:8s} {:10.3e} {:10.3e}&#39;.format(&#39;N2&#39;, self.n2.dat.data.min(), self.n2.dat.data.max()))</span>
            <span class="c1"># print_output(&#39;{:8s} {:10.3e} {:10.3e}&#39;.format(&#39;N2+&#39;, self.n2_pos.dat.data.min(), self.n2_pos.dat.data.max()))</span>
            <span class="c1"># print_output(&#39;{:8s} {:10.3e} {:10.3e}&#39;.format(&#39;N2-&#39;, self.n2_neg.dat.data.min(), self.n2_neg.dat.data.max()))</span>
            <span class="c1"># print_output(&#39;{:8s} {:10.3e} {:10.3e}&#39;.format(&#39;s_h&#39;, s_h.min(), s_h.max()))</span>
            <span class="c1"># print_output(&#39;{:8s} {:10.3e} {:10.3e}&#39;.format(&#39;s_m&#39;, s_m.min(), s_m.max()))</span>
            <span class="c1"># print_output(&#39;{:8s} {:10.3e} {:10.3e}&#39;.format(&#39;nuv&#39;, self.viscosity.dat.data.min(), self.viscosity.dat.data.max()))</span>
            <span class="c1"># print_output(&#39;{:8s} {:10.3e} {:10.3e}&#39;.format(&#39;muv&#39;, self.diffusivity.dat.data.min(), self.diffusivity.dat.data.max()))</span>


<div class="viewcode-block" id="TKESourceTerm"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.TKESourceTerm">[docs]</a><span class="k">class</span> <span class="nc">TKESourceTerm</span><span class="p">(</span><span class="n">TracerTerm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production and destruction terms of the TKE equation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_space</span><span class="p">,</span> <span class="n">gls_model</span><span class="p">,</span>
                 <span class="n">bathymetry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">v_elem_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h_elem_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TKESourceTerm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">function_space</span><span class="p">,</span>
                                            <span class="n">bathymetry</span><span class="p">,</span> <span class="n">v_elem_size</span><span class="p">,</span> <span class="n">h_elem_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gls_model</span> <span class="o">=</span> <span class="n">gls_model</span>

<div class="viewcode-block" id="TKESourceTerm.residual"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.TKESourceTerm.residual">[docs]</a>    <span class="k">def</span> <span class="nf">residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">solution_old</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">fields_old</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># TKE: P + B - eps</span>
        <span class="c1"># P = viscosity M**2           (production)</span>
        <span class="c1"># B = - diffusivity N**2       (byoyancy production)</span>
        <span class="c1"># M**2 = (du/dz)**2 + (dv/dz)**2 (shear frequency)</span>
        <span class="c1"># N**2 = -g\rho_0 (drho/dz)      (buoyancy frequency)</span>
        <span class="c1"># eps = (cmu0)**(3+p/n)*tke**(3/2+m/n)*psi**(-1/n)</span>
        <span class="c1">#                                (tke dissipation rate)</span>
        <span class="n">eddy_viscosity</span> <span class="o">=</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;viscosity_v&#39;</span><span class="p">]</span>
        <span class="n">eddy_diffusivity</span> <span class="o">=</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;diffusivity_v&#39;</span><span class="p">]</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">]</span>
        <span class="n">shear_freq2</span> <span class="o">=</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;shear_freq2&#39;</span><span class="p">]</span>
        <span class="n">buoy_freq2_neg</span> <span class="o">=</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;buoy_freq2_neg&#39;</span><span class="p">]</span>
        <span class="n">buoy_freq2_pos</span> <span class="o">=</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;buoy_freq2_pos&#39;</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">eddy_viscosity</span> <span class="o">*</span> <span class="n">shear_freq2</span>
        <span class="n">b_source</span> <span class="o">=</span> <span class="o">-</span> <span class="n">eddy_diffusivity</span> <span class="o">*</span> <span class="n">buoy_freq2_neg</span>
        <span class="n">b_sink</span> <span class="o">=</span> <span class="o">-</span> <span class="n">eddy_diffusivity</span> <span class="o">*</span> <span class="n">buoy_freq2_pos</span>

        <span class="n">source</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">b_source</span> <span class="o">+</span> <span class="p">(</span><span class="n">b_sink</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">)</span><span class="o">/</span><span class="n">solution_old</span><span class="o">*</span><span class="n">solution</span>  <span class="c1"># patankar</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
        <span class="k">return</span> <span class="n">f</span></div></div>


<div class="viewcode-block" id="PsiSourceTerm"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.PsiSourceTerm">[docs]</a><span class="k">class</span> <span class="nc">PsiSourceTerm</span><span class="p">(</span><span class="n">TracerTerm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Production and destruction terms of the TKE equation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_space</span><span class="p">,</span> <span class="n">gls_model</span><span class="p">,</span>
                 <span class="n">bathymetry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">v_elem_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h_elem_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PsiSourceTerm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">function_space</span><span class="p">,</span>
                                            <span class="n">bathymetry</span><span class="p">,</span> <span class="n">v_elem_size</span><span class="p">,</span> <span class="n">h_elem_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gls_model</span> <span class="o">=</span> <span class="n">gls_model</span>

<div class="viewcode-block" id="PsiSourceTerm.residual"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.PsiSourceTerm.residual">[docs]</a>    <span class="k">def</span> <span class="nf">residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">solution_old</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">fields_old</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># psi: psi/k*(c1*P + c3*B - c2*eps*f_wall)</span>
        <span class="c1"># P = viscosity M**2           (production)</span>
        <span class="c1"># B = - diffusivity N**2       (byoyancy production)</span>
        <span class="c1"># M**2 = (du/dz)**2 + (dv/dz)**2 (shear frequency)</span>
        <span class="c1"># N**2 = -g\rho_0 (drho/dz)      (buoyancy frequency)</span>
        <span class="c1"># eps = (cmu0)**(3+p/n)*tke**(3/2+m/n)*psi**(-1/n)</span>
        <span class="c1">#                                (tke dissipation rate)</span>
        <span class="n">eddy_viscosity</span> <span class="o">=</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;viscosity_v&#39;</span><span class="p">]</span>
        <span class="n">eddy_diffusivity</span> <span class="o">=</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;diffusivity_v&#39;</span><span class="p">]</span>
        <span class="n">diffusivity_v</span> <span class="o">=</span> <span class="n">eddy_viscosity</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">gls_model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">schmidt_nb_psi</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
        <span class="n">epsilon</span> <span class="o">=</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;epsilon&#39;</span><span class="p">]</span>
        <span class="n">shear_freq2</span> <span class="o">=</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;shear_freq2&#39;</span><span class="p">]</span>
        <span class="n">buoy_freq2_neg</span> <span class="o">=</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;buoy_freq2_neg&#39;</span><span class="p">]</span>
        <span class="n">buoy_freq2_pos</span> <span class="o">=</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;buoy_freq2_pos&#39;</span><span class="p">]</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">eddy_viscosity</span> <span class="o">*</span> <span class="n">shear_freq2</span>
        <span class="n">c1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gls_model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">c1</span>
        <span class="n">c2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gls_model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">c2</span>
        <span class="c1"># c3 switch: c3 = c3_minus if n2 &gt; 0 else c3_plus</span>
        <span class="n">c3_minus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gls_model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">c3_minus</span>
        <span class="n">c3_plus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gls_model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">c3_plus</span>  <span class="c1"># &gt; 0</span>
        <span class="k">assert</span> <span class="n">c3_plus</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;c3_plus has unexpected sign&#39;</span>
        <span class="n">b_shear</span> <span class="o">=</span> <span class="n">c3_plus</span> <span class="o">*</span> <span class="o">-</span><span class="n">eddy_diffusivity</span> <span class="o">*</span> <span class="n">buoy_freq2_neg</span>
        <span class="n">b_buoy</span> <span class="o">=</span> <span class="n">c3_minus</span> <span class="o">*</span> <span class="o">-</span><span class="n">eddy_diffusivity</span> <span class="o">*</span> <span class="n">buoy_freq2_pos</span>
        <span class="k">if</span> <span class="n">c3_minus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">b_source</span> <span class="o">=</span> <span class="n">b_shear</span>
            <span class="n">b_sink</span> <span class="o">=</span> <span class="n">b_buoy</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">b_source</span> <span class="o">=</span> <span class="n">b_shear</span> <span class="o">+</span> <span class="n">b_buoy</span>
            <span class="n">b_sink</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">f_wall</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gls_model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">f_wall</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">solution_old</span><span class="o">/</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">c1</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="n">b_source</span><span class="p">)</span> <span class="o">+</span> <span class="n">solution</span><span class="o">/</span><span class="n">k</span><span class="o">*</span><span class="p">(</span><span class="n">b_sink</span> <span class="o">-</span> <span class="n">c2</span><span class="o">*</span><span class="n">f_wall</span><span class="o">*</span><span class="n">epsilon</span><span class="p">)</span>  <span class="c1"># patankar</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>

        <span class="c1"># add bottom/top boundary condition for psi</span>
        <span class="c1"># (nuv_v/sigma_psi * dpsi/dz)_b = n * nuv_v/sigma_psi * (cmu0)^p * k^m * kappa^n * z_b^(n-1)</span>
        <span class="c1"># z_b = distance_from_bottom + z_0 (Burchard and Petersen, 1999)</span>
        <span class="n">cmu0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gls_model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">cmu0</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gls_model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">p</span>
        <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gls_model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">m</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gls_model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">n</span>
        <span class="n">z0_friction</span> <span class="o">=</span> <span class="n">physical_constants</span><span class="p">[</span><span class="s1">&#39;z0_friction&#39;</span><span class="p">]</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="n">physical_constants</span><span class="p">[</span><span class="s1">&#39;von_karman&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_elem_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;v_elem_size required&#39;</span><span class="p">)</span>
        <span class="c1"># bottom condition</span>
        <span class="n">z_b</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">v_elem_size</span> <span class="o">+</span> <span class="n">z0_friction</span>
        <span class="n">diff_flux</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">diffusivity_v</span><span class="o">*</span><span class="p">(</span><span class="n">cmu0</span><span class="p">)</span><span class="o">**</span><span class="n">p</span> <span class="o">*</span>
                     <span class="n">k</span><span class="o">**</span><span class="n">m</span> <span class="o">*</span> <span class="n">kappa</span><span class="o">**</span><span class="n">n</span> <span class="o">*</span> <span class="n">z_b</span><span class="o">**</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">+=</span> <span class="n">diff_flux</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">normal</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">ds_bottom</span>
        <span class="c1"># surface condition</span>
        <span class="n">z0_surface</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">v_elem_size</span> <span class="o">+</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.02</span><span class="p">)</span>  <span class="c1"># TODO generalize</span>
        <span class="n">z_s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">v_elem_size</span> <span class="o">+</span> <span class="n">z0_surface</span>
        <span class="n">diff_flux</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">diffusivity_v</span><span class="o">*</span><span class="p">(</span><span class="n">cmu0</span><span class="p">)</span><span class="o">**</span><span class="n">p</span> <span class="o">*</span>
                      <span class="n">k</span><span class="o">**</span><span class="n">m</span> <span class="o">*</span> <span class="n">kappa</span><span class="o">**</span><span class="n">n</span> <span class="o">*</span> <span class="n">z_s</span><span class="o">**</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">+=</span> <span class="n">diff_flux</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">test</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">normal</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">ds_surf</span>

        <span class="k">return</span> <span class="n">f</span></div></div>


<div class="viewcode-block" id="GLSVerticalDiffusionTerm"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.GLSVerticalDiffusionTerm">[docs]</a><span class="k">class</span> <span class="nc">GLSVerticalDiffusionTerm</span><span class="p">(</span><span class="n">VerticalDiffusionTerm</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Vertical diffusion term where diffusivity is replaced by viscosity/Schmidt number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_space</span><span class="p">,</span> <span class="n">schmidt_nb</span><span class="p">,</span>
                 <span class="n">bathymetry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">v_elem_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h_elem_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GLSVerticalDiffusionTerm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">function_space</span><span class="p">,</span>
                                                       <span class="n">bathymetry</span><span class="p">,</span> <span class="n">v_elem_size</span><span class="p">,</span> <span class="n">h_elem_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schmidt_nb</span> <span class="o">=</span> <span class="n">schmidt_nb</span>

<div class="viewcode-block" id="GLSVerticalDiffusionTerm.residual"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.GLSVerticalDiffusionTerm.residual">[docs]</a>    <span class="k">def</span> <span class="nf">residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">solution_old</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">fields_old</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;diffusivity_v&#39;</span><span class="p">:</span> <span class="n">fields_old</span><span class="p">[</span><span class="s1">&#39;viscosity_v&#39;</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">schmidt_nb</span><span class="p">}</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">GLSVerticalDiffusionTerm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span> <span class="n">solution_old</span><span class="p">,</span>
                                                           <span class="n">d</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span></div></div>


<div class="viewcode-block" id="TKEEquation"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.TKEEquation">[docs]</a><span class="k">class</span> <span class="nc">TKEEquation</span><span class="p">(</span><span class="n">Equation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turbulent kinetic energy equation without advection terms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_space</span><span class="p">,</span> <span class="n">gls_model</span><span class="p">,</span>
                 <span class="n">bathymetry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">v_elem_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h_elem_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TKEEquation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">function_space</span><span class="p">)</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="n">GLSVerticalDiffusionTerm</span><span class="p">(</span><span class="n">function_space</span><span class="p">,</span>
                                        <span class="n">gls_model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">schmidt_nb_tke</span><span class="p">,</span>
                                        <span class="n">bathymetry</span><span class="p">,</span> <span class="n">v_elem_size</span><span class="p">,</span> <span class="n">h_elem_size</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">TKESourceTerm</span><span class="p">(</span><span class="n">function_space</span><span class="p">,</span>
                               <span class="n">gls_model</span><span class="p">,</span>
                               <span class="n">bathymetry</span><span class="p">,</span> <span class="n">v_elem_size</span><span class="p">,</span> <span class="n">h_elem_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_term</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;implicit&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_term</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="s1">&#39;implicit&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="PsiEquation"><a class="viewcode-back" href="../../thetis.html#thetis.turbulence.PsiEquation">[docs]</a><span class="k">class</span> <span class="nc">PsiEquation</span><span class="p">(</span><span class="n">Equation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Psi equation without advection terms.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_space</span><span class="p">,</span> <span class="n">gls_model</span><span class="p">,</span>
                 <span class="n">bathymetry</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">v_elem_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h_elem_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PsiEquation</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">function_space</span><span class="p">)</span>

        <span class="n">diff</span> <span class="o">=</span> <span class="n">GLSVerticalDiffusionTerm</span><span class="p">(</span><span class="n">function_space</span><span class="p">,</span>
                                        <span class="n">gls_model</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">schmidt_nb_psi</span><span class="p">,</span>
                                        <span class="n">bathymetry</span><span class="p">,</span> <span class="n">v_elem_size</span><span class="p">,</span> <span class="n">h_elem_size</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">PsiSourceTerm</span><span class="p">(</span><span class="n">function_space</span><span class="p">,</span>
                               <span class="n">gls_model</span><span class="p">,</span>
                               <span class="n">bathymetry</span><span class="p">,</span> <span class="n">v_elem_size</span><span class="p">,</span> <span class="n">h_elem_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_term</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="s1">&#39;implicit&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_term</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;implicit&#39;</span><span class="p">)</span></div>
</pre></div>

          </div>
        </div>
      </div>
    </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016, Tuomas Karna et al..
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.5.
    </div>
  </body>
</html>